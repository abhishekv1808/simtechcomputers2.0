<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head') %>
</head>
<body class="bg-[var(--admin-bg)] flex font-sans antialiased text-[var(--admin-text-main)] h-screen overflow-hidden selection:bg-blue-500 selection:text-white transition-colors duration-300">

    <%- include('./includes/navigation') %>

    <main class="flex-grow h-screen overflow-y-auto w-full relative">
        <!-- Header -->
        <header class="bg-[var(--admin-bg)]/95 backdrop-blur-sm h-16 flex items-center justify-between px-8 sticky top-0 z-20 transition-colors duration-300">
            <h2 class="text-xl font-bold text-[var(--admin-text-main)]"><% if (editing) { %>Edit Product<% } else { %>Add Product<% } %></h2>
            <a href="/admin/products" class="text-[var(--admin-text-muted)] hover:text-[var(--admin-text-main)] flex items-center gap-2 text-sm font-bold transition-colors">
                <i class="ri-arrow-left-line"></i> Back to Inventory
            </a>
        </header>

        <div class="p-8 max-w-4xl mx-auto">
            
            <div class="bg-[var(--admin-card)] rounded-xl border border-[var(--admin-border)] shadow-lg p-8">
                <form action="/admin/<% if (editing) { %>edit-product<% } else { %>add-product<% } %>" method="POST" enctype="multipart/form-data" class="space-y-6" novalidate>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Name -->
                        <div class="md:col-span-2">
                            <label for="name" class="block text-sm font-bold text-[var(--admin-text-muted)] mb-2">Product Name</label>
                            <input type="text" name="name" id="name" value="<% if (editing) { %><%= product.name %><% } %>" class="w-full bg-[var(--admin-hover)] border border-[var(--admin-border)] text-[var(--admin-text-main)] rounded-lg px-4 py-3 focus:outline-none focus:border-[#0071dc] transition-colors placeholder-gray-400" placeholder="e.g. MacBook Pro M1 13-inch" required>
                        </div>

                        <!-- Brand -->
                        <div>
                            <label for="brand" class="block text-sm font-bold text-[var(--admin-text-muted)] mb-2">Brand</label>
                             <select name="brand" id="brand" class="w-full bg-[var(--admin-hover)] border border-[var(--admin-border)] text-[var(--admin-text-main)] rounded-lg px-4 py-3 focus:outline-none focus:border-[#0071dc] transition-colors" required>
                                <option value="" disabled selected>Select Brand</option>
                                <option value="Apple" <% if (editing && product.brand === 'Apple') { %>selected<% } %>>Apple</option>
                                <option value="Dell" <% if (editing && product.brand === 'Dell') { %>selected<% } %>>Dell</option>
                                <option value="HP" <% if (editing && product.brand === 'HP') { %>selected<% } %>>HP</option>
                                <option value="Lenovo" <% if (editing && product.brand === 'Lenovo') { %>selected<% } %>>Lenovo</option>
                                <option value="Samsung" <% if (editing && product.brand === 'Samsung') { %>selected<% } %>>Samsung</option>
                                <option value="LG" <% if (editing && product.brand === 'LG') { %>selected<% } %>>LG</option>
                                <option value="BenQ" <% if (editing && product.brand === 'BenQ') { %>selected<% } %>>BenQ</option>
                                <option value="Acer" <% if (editing && product.brand === 'Acer') { %>selected<% } %>>Acer</option>
                                <option value="MSI" <% if (editing && product.brand === 'MSI') { %>selected<% } %>>MSI</option>
                            </select>
                        </div>

                        <!-- Category -->
                        <div>
                            <label for="category" class="block text-sm font-bold text-[var(--admin-text-muted)] mb-2">Category</label>
                            <select name="category" id="category" class="w-full bg-[var(--admin-hover)] border border-[var(--admin-border)] text-[var(--admin-text-main)] rounded-lg px-4 py-3 focus:outline-none focus:border-[#0071dc] transition-colors" required>
                                <option value="" disabled <% if (!editing && !category) { %>selected<% } %>>Select Category</option>
                                <option value="laptop" <% if ((editing && product.category === 'laptop') || (!editing && category === 'laptop')) { %>selected<% } %>>Laptop</option>
                                <option value="desktop" <% if ((editing && product.category === 'desktop') || (!editing && category === 'desktop')) { %>selected<% } %>>Desktop</option>
                                <option value="monitor" <% if ((editing && product.category === 'monitor') || (!editing && category === 'monitor')) { %>selected<% } %>>Monitor</option>
                                <option value="accessory" <% if ((editing && product.category === 'accessory') || (!editing && category === 'accessory')) { %>selected<% } %>>Accessory</option>
                            </select>
                        </div>

                        <!-- Price -->
                        <div>
                            <label for="price" class="block text-sm font-bold text-[var(--admin-text-muted)] mb-2">Selling Price (₹)</label>
                            <input type="number" name="price" id="price" value="<% if (editing) { %><%= product.price %><% } %>" class="w-full bg-[var(--admin-hover)] border border-[var(--admin-border)] text-[var(--admin-text-main)] rounded-lg px-4 py-3 focus:outline-none focus:border-[#0071dc] transition-colors" required>
                        </div>

                        <!-- MRP -->
                        <div>
                            <label for="mrp" class="block text-sm font-bold text-[var(--admin-text-muted)] mb-2">MRP (₹)</label>
                            <input type="number" name="mrp" id="mrp" value="<% if (editing) { %><%= product.mrp %><% } %>" class="w-full bg-[var(--admin-hover)] border border-[var(--admin-border)] text-[var(--admin-text-main)] rounded-lg px-4 py-3 focus:outline-none focus:border-[#0071dc] transition-colors" required>
                        </div>



                        <!-- Quantity -->
                        <div>
                            <label for="quantity" class="block text-sm font-bold text-[var(--admin-text-muted)] mb-2">Stock Quantity</label>
                            <input type="number" name="quantity" id="quantity" value="<% if (editing) { %><%= product.quantity %><% } %>" class="w-full bg-[var(--admin-hover)] border border-[var(--admin-border)] text-[var(--admin-text-main)] rounded-lg px-4 py-3 focus:outline-none focus:border-[#0071dc] transition-colors" required>
                        </div>

                        <!-- Image Upload -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold text-[var(--admin-text-muted)] mb-2">Product Images</label>
                            
                            <% if (editing && product.images && product.images.length > 0) { %>
                                <div class="mb-4">
                                    <p class="text-xs text-[var(--admin-text-muted)] mb-2">Current Images:</p>
                                    <div class="flex flex-wrap gap-4">
                                        <% product.images.forEach(img => { %>
                                            <div class="w-32 h-32 rounded-lg overflow-hidden border border-[var(--admin-border)] relative group">
                                                <img src="<%= img %>" alt="Product Image" class="w-full h-full object-cover">
                                                <button type="button" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center shadow-sm opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600" onclick="deleteImage('<%= product._id %>', '<%= img %>')">
                                                    <i class="ri-delete-bin-line text-xs"></i>
                                                </button>
                                            </div>
                                        <% }) %>
                                    </div>
                                </div>
                            <% } else if (editing && product.image) { %>
                                <div class="mb-4">
                                    <p class="text-xs text-[var(--admin-text-muted)] mb-2">Current Main Image:</p>
                                    <div class="w-32 h-32 rounded-lg overflow-hidden border border-[var(--admin-border)] relative group">
                                        <img src="<%= product.image %>" alt="Current Image" class="h-full w-full object-cover">
                                    </div>
                                </div>
                            <% } %>

                            <div id="drop-zone" class="w-full h-48 border-2 border-dashed border-[var(--admin-border)] hover:border-[#0071dc] rounded-xl flex flex-col items-center justify-center bg-[var(--admin-hover)]/30 transition-all cursor-pointer relative overflow-hidden group" onclick="document.getElementById('file-input').click()">
                                <input type="file" name="images" id="file-input" class="hidden" accept="image/*" multiple>
                                
                                <div class="text-center transition-transform group-hover:scale-105 z-10 pointer-events-none">
                                    <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3">
                                        <i class="ri-upload-cloud-2-line text-2xl"></i>
                                    </div>
                                    <p class="text-[var(--admin-text-main)] font-bold">Click to upload or drag and drop</p>
                                    <p class="text-[var(--admin-text-muted)] text-xs mt-1">New uploads will replace existing images</p>
                                </div>
                            </div>

                            <!-- Preview Area -->
                            <div id="preview-area" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 empty:hidden"></div>
                        </div>

                         <!-- Description -->
                         <div class="md:col-span-2">
                            <label for="description" class="block text-sm font-bold text-[var(--admin-text-muted)] mb-2">Description</label>
                            <textarea name="description" id="description" rows="5" class="w-full bg-[var(--admin-hover)] border border-[var(--admin-border)] text-[var(--admin-text-main)] rounded-lg px-4 py-3 focus:outline-none focus:border-[#0071dc] transition-colors"><% if (editing) { %><%= product.description %><% } %></textarea>
                        </div>

                    </div>

                    <% if (editing) { %>
                        <input type="hidden" name="productId" value="<%= product._id %>">
                    <% } %>

                    <div class="pt-6 border-t border-[var(--admin-border)] flex justify-end gap-4">
                        <a href="/admin/products" class="px-6 py-3 rounded-lg border border-[var(--admin-border)] text-[var(--admin-text-muted)] hover:text-[var(--admin-text-main)] hover:bg-[var(--admin-hover)] font-bold transition-all">Cancel</a>
                        <button type="submit" class="px-8 py-3 rounded-lg bg-[#0071dc] hover:bg-blue-600 text-white font-bold shadow-lg hover:shadow-xl transition-all">
                            <% if (editing) { %>Update Product<% } else { %>Create Product<% } %>
                        </button>
                    </div>

                </form>
            </div>

        </div>
    </main>
    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/50 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-xl shadow-2xl p-8 transform transition-all scale-100 max-w-sm w-full text-center">
            <div class="w-16 h-16 bg-green-100 dark:bg-green-900/30 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 animate-[bounce_1s_infinite]">
                <i class="ri-check-line text-3xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-[var(--admin-text-main)] mb-2">Success!</h3>
            <p class="text-[var(--admin-text-muted)]">Product updated successfully.</p>
            <div class="mt-6 w-full bg-gray-200 rounded-full h-1.5 dark:bg-gray-700 overflow-hidden">
                <div class="bg-green-500 h-1.5 rounded-full animate-[width_3s_linear_forwards]" style="width: 0%"></div>
            </div>
            <p class="text-xs text-[var(--admin-text-muted)] mt-2">Redirecting to inventory...</p>
        </div>
    </div>

    <style>
        @keyframes width {
            from { width: 0%; }
            to { width: 100%; }
        }
    </style>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const previewArea = document.getElementById('preview-area');
        const dataTransfer = new DataTransfer();

        // Check for success param
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('success') === 'true') {
            const modal = document.getElementById('successModal');
            modal.classList.remove('hidden');
            // Animate entrance
            modal.querySelector('div').classList.add('scale-100');
            modal.querySelector('div').classList.remove('scale-95');
            
            setTimeout(() => {
                window.location.href = '/admin/products';
            }, 3000);
        }

        // Drag & Drop visual effects
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('border-[#0071dc]', 'bg-blue-50', 'dark:bg-blue-900/10');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('border-[#0071dc]', 'bg-blue-50', 'dark:bg-blue-900/10');
            }, false);
        });

        const updatePreview = () => {
            previewArea.innerHTML = '';
            Array.from(dataTransfer.files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'relative group rounded-lg overflow-hidden border border-[var(--admin-border)] aspect-square';
                    div.innerHTML = `
                        <img src="${e.target.result}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center text-white">
                             <span class="text-xs font-medium">${(file.size / 1024).toFixed(1)} KB</span>
                        </div>
                         <button type="button" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center shadow-sm opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600" onclick="removeFile(${index})">
                            <i class="ri-close-line"></i>
                        </button>
                    `;
                    previewArea.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        };

        window.removeFile = (index) => {
            const newDt = new DataTransfer();
            Array.from(dataTransfer.files).forEach((file, i) => {
                if (i !== index) newDt.items.add(file);
            });
            dataTransfer.items.clear();
            Array.from(newDt.files).forEach(file => dataTransfer.items.add(file));
            
            fileInput.files = dataTransfer.files;
            updatePreview();
        };

        const handleFiles = (files) => {
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    dataTransfer.items.add(file);
                }
            });
            fileInput.files = dataTransfer.files;
            updatePreview();
        };

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        dropZone.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            handleFiles(dt.files);
        });
        // Delete Image Handler
        function deleteImage(productId, imageUrl) {
            if (confirm('Are you sure you want to delete this image?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/admin/delete-image';
                
                const productIdInput = document.createElement('input');
                productIdInput.type = 'hidden';
                productIdInput.name = 'productId';
                productIdInput.value = productId;
                
                const imageUrlInput = document.createElement('input');
                imageUrlInput.type = 'hidden';
                imageUrlInput.name = 'imageUrl';
                imageUrlInput.value = imageUrl;
                
                form.appendChild(productIdInput);
                form.appendChild(imageUrlInput);
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
</body>
</html>
