<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head') %>
</head>
<body class="bg-[var(--admin-bg)] flex font-sans antialiased text-[var(--admin-text-main)] h-screen overflow-hidden selection:bg-red-500 selection:text-white transition-colors duration-300">

    <%- include('./includes/navigation') %>

    <main class="flex-grow h-screen overflow-y-auto w-full relative bg-[var(--admin-bg)]">
        <div class="p-6 max-w-[800px] mx-auto">
            
            <div class="bg-[var(--admin-card)] rounded-xl border border-[var(--admin-border)] shadow-sm">
                <!-- Header inside card -->
                <div class="px-6 py-4 border-b border-[var(--admin-border)] flex items-center justify-between">
                    <h2 class="text-3xl font-bold text-[var(--admin-text-main)]">Send Push Notification</h2>
                </div>

                <form action="/admin/send-notification" method="POST" enctype="multipart/form-data" class="p-6">
                    
                    <% if (errorMessage) { %>
                        <div class="mb-6 bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm flex items-center gap-2" role="alert">
                            <i class="ri-error-warning-fill"></i>
                            <span><%= errorMessage %></span>
                        </div>
                    <% } %>
                    
                    <% if (successMessage) { %>
                        <!-- Success Modal -->
                        <div id="successModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm opacity-0 transition-opacity duration-300 pointer-events-none">
                            <div class="bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-2xl shadow-2xl p-8 transform scale-95 transition-transform duration-300 flex flex-col items-center max-w-sm w-full mx-4">
                                <div class="w-16 h-16 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mb-4 text-green-600 dark:text-green-400 text-3xl shadow-sm">
                                    <i class="ri-checkbox-circle-fill"></i>
                                </div>
                                <h3 class="text-xl font-bold text-[var(--admin-text-main)] mb-2">Success!</h3>
                                <p class="text-[var(--admin-text-muted)] text-center"><%= successMessage %></p>
                            </div>
                        </div>

                        <script>
                            document.addEventListener('DOMContentLoaded', () => {
                                const modal = document.getElementById('successModal');
                                const modalContent = modal.querySelector('div');

                                // Show
                                setTimeout(() => {
                                    modal.classList.remove('opacity-0', 'pointer-events-none');
                                    modalContent.classList.remove('scale-95');
                                    modalContent.classList.add('scale-100');
                                }, 100);

                                // Hide after 3s
                                setTimeout(() => {
                                    modal.classList.add('opacity-0', 'pointer-events-none');
                                    modalContent.classList.remove('scale-100');
                                    modalContent.classList.add('scale-95');
                                }, 3000);
                            });
                        </script>
                    <% } %>

                    <div class="space-y-8">

                        <!-- Section 1: Notification Details -->
                        <div class="bg-[var(--admin-card)] rounded-xl border border-[var(--admin-border)] p-6 shadow-sm">
                            <h3 class="text-lg font-bold text-[var(--admin-text-main)] mb-4 flex items-center gap-2">
                                <i class="ri-notification-3-line text-red-500"></i> Notification Details
                            </h3>
                            <div class="grid grid-cols-1 gap-6">
                                <div>
                                    <label class="block text-xs font-bold text-[var(--admin-text-muted)] uppercase tracking-wider mb-2">Target Audience</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="ri-group-line text-gray-400"></i>
                                        </div>
                                        <select name="audience" class="w-full pl-10 bg-[var(--admin-hover)] border border-[var(--admin-border)] text-[var(--admin-text-main)] rounded-lg px-3 py-2.5 text-sm focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-colors appearance-none">
                                            <option value="all">All Subscribers</option>
                                        </select>
                                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                            <i class="ri-arrow-down-s-line text-gray-400"></i>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-[var(--admin-text-muted)] uppercase tracking-wider mb-2">Notification Title</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="ri-notification-badge-line text-gray-400"></i>
                                        </div>
                                        <input type="text" name="title" class="w-full pl-10 bg-[var(--admin-hover)] border border-[var(--admin-border)] text-[var(--admin-text-main)] rounded-lg px-3 py-2.5 text-sm focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-colors" placeholder="e.g. Big Sale Starting Now!" required>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-[var(--admin-text-muted)] uppercase tracking-wider mb-2">Message Body</label>
                                    <div class="relative">
                                        <textarea name="body" rows="4" class="w-full bg-[var(--admin-hover)] border border-[var(--admin-border)] text-[var(--admin-text-main)] rounded-lg px-3 py-2.5 text-sm focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-colors resize-none" placeholder="e.g. Get 50% off on all Laptops. Limited time offer." required></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: Media -->
                        <div class="bg-[var(--admin-card)] rounded-xl border border-[var(--admin-border)] p-6 shadow-sm">
                            <h3 class="text-lg font-bold text-[var(--admin-text-main)] mb-4 flex items-center gap-2">
                                <i class="ri-image-line text-orange-500"></i> Media
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Large Image (Banner) -->
                                <div>
                                    <label class="block text-xs font-bold text-[var(--admin-text-muted)] uppercase tracking-wider mb-2">Large Image (Banner)</label>
                                    <div id="drop-zone-image" class="w-full h-[200px] border-2 border-dashed border-[var(--admin-border)] hover:border-red-500 rounded-xl flex flex-col items-center justify-center bg-[var(--admin-hover)]/30 transition-all cursor-pointer relative overflow-hidden group">
                                        <input type="file" name="image" id="file-input-image" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" accept="image/*">
                                        <div class="text-center pointer-events-none">
                                            <div class="w-12 h-12 bg-red-50 dark:bg-red-900/20 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                                                <i class="ri-image-line text-2xl text-red-500"></i>
                                            </div>
                                            <p class="text-[var(--admin-text-main)] font-medium text-sm">Banner Image</p>
                                            <p class="text-[var(--admin-text-muted)] text-xs mt-1">Click to upload or drag and drop</p>
                                        </div>
                                    </div>
                                    <div id="preview-area-image" class="mt-4 empty:hidden"></div>
                                </div>

                                <!-- Notification Icon -->
                                <div>
                                    <label class="block text-xs font-bold text-[var(--admin-text-muted)] uppercase tracking-wider mb-2">Notification Icon (Optional)</label>
                                    <div id="drop-zone-icon" class="w-full h-[200px] border-2 border-dashed border-[var(--admin-border)] hover:border-red-500 rounded-xl flex flex-col items-center justify-center bg-[var(--admin-hover)]/30 transition-all cursor-pointer relative overflow-hidden group">
                                        <input type="file" name="icon" id="file-input-icon" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" accept="image/*">
                                        <div class="text-center pointer-events-none">
                                            <div class="w-12 h-12 bg-purple-50 dark:bg-purple-900/20 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                                                <i class="ri-notification-badge-line text-2xl text-purple-500"></i>
                                            </div>
                                            <p class="text-[var(--admin-text-main)] font-medium text-sm">Small Icon</p>
                                            <p class="text-[var(--admin-text-muted)] text-xs mt-1">Click to upload or drag and drop</p>
                                        </div>
                                    </div>
                                    <div id="preview-area-icon" class="mt-4 empty:hidden"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Section 3: Actions & Links -->
                        <div class="bg-[var(--admin-card)] rounded-xl border border-[var(--admin-border)] p-6 shadow-sm">
                            <h3 class="text-lg font-bold text-[var(--admin-text-main)] mb-4 flex items-center gap-2">
                                <i class="ri-links-line text-green-500"></i> Actions & Links
                            </h3>
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-xs font-bold text-[var(--admin-text-muted)] uppercase tracking-wider mb-2">Target URL (Optional)</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="ri-link text-gray-400"></i>
                                        </div>
                                        <input type="text" name="url" class="w-full pl-10 bg-[var(--admin-hover)] border border-[var(--admin-border)] text-[var(--admin-text-main)] rounded-lg px-3 py-2.5 text-sm focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-colors" placeholder="e.g. /laptops or https://simtech.com/offers">
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Action 1 -->
                                    <div class="p-4 bg-[var(--admin-hover)]/30 rounded-xl border border-[var(--admin-border)]">
                                        <h4 class="text-sm font-bold text-[var(--admin-text-main)] mb-3 flex items-center gap-2">
                                            <span class="w-6 h-6 rounded-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 flex items-center justify-center text-xs">1</span>
                                            Action Button 1
                                        </h4>
                                        <div class="space-y-3">
                                            <div>
                                                <label class="block text-xs text-[var(--admin-text-muted)] mb-1">Button Title</label>
                                                <input type="text" name="action1_title" class="w-full bg-[var(--admin-bg)] border border-[var(--admin-border)] text-[var(--admin-text-main)] rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500" placeholder="e.g. View Offer">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-[var(--admin-text-muted)] mb-1">Action URL</label>
                                                <input type="text" name="action1_url" class="w-full bg-[var(--admin-bg)] border border-[var(--admin-border)] text-[var(--admin-text-main)] rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500" placeholder="e.g. /offers">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Action 2 -->
                                    <div class="p-4 bg-[var(--admin-hover)]/30 rounded-xl border border-[var(--admin-border)]">
                                        <h4 class="text-sm font-bold text-[var(--admin-text-main)] mb-3 flex items-center gap-2">
                                            <span class="w-6 h-6 rounded-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 flex items-center justify-center text-xs">2</span>
                                            Action Button 2
                                        </h4>
                                        <div class="space-y-3">
                                            <div>
                                                <label class="block text-xs text-[var(--admin-text-muted)] mb-1">Button Title</label>
                                                <input type="text" name="action2_title" class="w-full bg-[var(--admin-bg)] border border-[var(--admin-border)] text-[var(--admin-text-main)] rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500" placeholder="e.g. Call Now">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-[var(--admin-text-muted)] mb-1">Action URL</label>
                                                <input type="text" name="action2_url" class="w-full bg-[var(--admin-bg)] border border-[var(--admin-border)] text-[var(--admin-text-main)] rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500" placeholder="e.g. tel:+1234567890">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="pt-6 mt-6 border-t border-[var(--admin-border)] flex justify-end gap-3">
                        <button type="submit" class="px-6 py-2.5 rounded-lg bg-red-600 hover:bg-red-700 text-white text-sm font-bold shadow-lg shadow-red-900/20 transition-all flex items-center gap-2">
                            <i class="ri-send-plane-fill"></i> Send Notification
                        </button>
                    </div>

                </form>
            </div>
        </div>
    </main>

    <script>
        const setupDragAndDrop = (dropZoneId, fileInputId, previewAreaId) => {
            const dropZone = document.getElementById(dropZoneId);
            const fileInput = document.getElementById(fileInputId);
            const previewArea = document.getElementById(previewAreaId);

            // Drag & Drop visual effects
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropZone.classList.add('border-red-500', 'bg-red-50', 'dark:bg-red-900/10');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropZone.classList.remove('border-red-500', 'bg-red-50', 'dark:bg-red-900/10');
                }, false);
            });

            const updatePreview = (file) => {
                previewArea.innerHTML = '';
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'relative group rounded-lg overflow-hidden border border-[var(--admin-border)] w-24 h-24';
                    div.innerHTML = `
                        <img src="${e.target.result}" class="w-full h-full object-cover">
                        <button type="button" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center shadow-sm opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600" onclick="removeFile('${fileInputId}', '${previewAreaId}')">
                            <i class="ri-close-line text-xs"></i>
                        </button>
                    `;
                    previewArea.appendChild(div);
                };
                reader.readAsDataURL(file);
            };

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    updatePreview(e.target.files[0]);
                }
            });

            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    updatePreview(files[0]);
                }
            });
        };

        // Initialize for both inputs
        setupDragAndDrop('drop-zone-image', 'file-input-image', 'preview-area-image');
        setupDragAndDrop('drop-zone-icon', 'file-input-icon', 'preview-area-icon');

        window.removeFile = (inputId, previewId) => {
            document.getElementById(inputId).value = '';
            document.getElementById(previewId).innerHTML = '';
        };
    </script>
